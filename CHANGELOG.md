# üìã Changelog

Todas as mudan√ßas importantes neste projeto ser√£o documentadas neste arquivo.

O formato √© baseado em [Keep a Changelog](https://keepachangelog.com/pt-BR/1.0.0/),
e este projeto adere ao [Semantic Versioning](https://semver.org/lang/pt-BR/).

# üìã Changelog

Todas as mudan√ßas importantes neste projeto ser√£o documentadas neste arquivo.

O formato √© baseado em [Keep a Changelog](https://keepachangelog.com/pt-BR/1.0.0/),
e este projeto adere ao [Semantic Versioning](https://semver.org/lang/pt-BR/).

## [v1.2.5] - 2025-10-17

### ‚ú® Destaques da vers√£o
- Eventos individuais agora utilizam o mesmo buffer persistente dos eventos globais, garantindo **ZERO perda** com retentativas consistentes e circuit breaker por transporte.
- Observabilidade completa: logger unificado com Sentry, spans de lifecycle no OpenTelemetry e middleware dedicado para cada requisi√ß√£o HTTP/Admin.
- Novos recursos de API: **Eco de mensagens** (API Echo), sincroniza√ß√£o de chats/app-state sob demanda e refor√ßo de DLQ com prune manual via painel admin.
- Stack de transportes global revisada com sanitiza√ß√£o de metadados, retries configur√°veis e defaults centralizados para SQS, Redis, Webhook e RabbitMQ.

### üöÄ Novos Recursos

#### üßµ Buffer persistente para eventos individuais
- **Integra√ß√£o completa do Sprint 2**: webhooks e RabbitMQ individuais foram migrados para o mesmo buffer dur√°vel (`buffer/database.go`, `buffer/pruner.go`).
- Novo arquivo `individual_transports.go` implementa `EventTransport` para webhooks e RabbitMQ com registro din√¢mico por usu√°rio.
- `wmiau.go` ganhou `dispatchIndividualEvent()` e substituiu todas as chamadas diretas por envios via dispatcher ‚Üí buffer ‚Üí worker pool.
- `webhook.go` introduziu `sendWebhookSync()` com contexto, timeout, retentativa exponencial e cabe√ßalho `X-Event-ID`.
- `rabbitmq.go` traz `publishMessageSync()` e `GetUserConfig()` para garantir idempot√™ncia (`MessageId`) e carregamento de overrides por usu√°rio.
- `global_dispatcher.go` administra `individualWorkers`, registra/atualiza transportes (`RegisterIndividualTransport`) e garante enqueue com retry exponencial.
- CLI `cmd/loadtest` + bin√°rio `bin/loadtest` permitem estressar os buffers (memory, SQLite, Postgres, MySQL) com m√©tricas de enfileiramento e consumo.

#### üåê API & Admin
- Novos endpoints:
  - `POST /admin/dlq/prune` ‚Äî dispara prune imediato no buffer persistente (inclui estat√≠sticas quando dispon√≠veis).
  - `POST /session/echo/api` e `GET /session/echo/api` ‚Äî habilitam/desabilitam e consultam o eco de mensagens da API.
  - `GET /chat/list`, `POST /sync/app-state`, `POST /sync/history-request`, `POST /sync/full-history` ‚Äî exp√µem sincroniza√ß√£o de chats, patches e Full History On Demand.
- `/chat/delete-chat` remove conversas via app state com suporte a metadados da √∫ltima mensagem.
- Eventos enviados pela API passam a gerar eco interno (`api_echo.go`) com envelopes padronizados, respeitando cache de configura√ß√µes.
- O payload de eco agora carrega o wrapper `apiMessagePayload` com flag `Info.IsFromAPI`, preservando `RawMessage`, `SourceWebMsg`, metadados de newsletter e marcadores de mensagens ef√™meras (`IsViewOnce`, `IsDocumentWithCaption`, etc.), permitindo que consumidores diferenciem mensagens originadas pela API de mensagens recebidas normalmente.
- `admin_dlq_handlers.go` ganhou tratamento dedicado para erros `ErrDLQNotFound`, dry-run, exclus√£o em lote e replay com contagem, reduzindo ambiguidade em diagn√≥sticos.

#### üé® Mensagens interativas
- `send_handlers.go` foi ampliado para suportar *carross√©is interativos*, rich cards com m√∫ltiplos bot√µes, listas e templates, compartilhando a mesma infraestrutura de eco e buffer.
- Fun√ß√µes utilit√°rias normalizam bot√µes (`normalizeCarouselButton`) e cards (`normalizeCarouselCard`), garantindo compatibilidade com o cliente e quedas controladas quando o payload estiver fora do formato.
- O fork `whatsmeow` passou a preservar `ContextInfo` e demais campos necess√°rios para flows e carross√©is, evitando perda de experi√™ncia no app final.

#### üí¨ Mensagens interativas e licenciamento
- Libera√ß√£o oficial de **bot√µes interativos**, **textos din√¢micos** e **flows** para clientes com licen√ßa Enterprise.
- `LICENSE_KEY` agora valida o sufixo `-ENT-` para habilitar recursos avan√ßados ‚Äì o arquivo `.env.sample` descreve claramente os n√≠veis **BASIC** (default) e **ENTERPRISE**.
- Implementamos o `server.setup` para identificar a licen√ßa ativa logo no in√≠cio da aplica√ß√£o e disponibilizar os novos handlers (`send_handlers.go`) apenas quando habilitados.
- Novos planos dispon√≠veis:
  - **Assinatura mensal (Premium com bot√µes interativos)**:
  - **Assinatura anual (Premium com bot√µes interativos)**: 
- Documenta√ß√£o atualizada em `README.md` e `CLAUDE.md` ressaltando o processo de upgrade e o contato com o suporte DinastiAPI para ativa√ß√£o imediata.

#### üî≠ Observabilidade e Resili√™ncia
- `setupLogger()` (main) aplica flags + envs e injeta `SentryWriter`, garantindo captura autom√°tica de logs `error|fatal|panic`.
- Middleware de tracing (`tracingMiddleware`) e Sentry (`sentryMiddleware`) instrumentam todas as rotas (REST e admin) com spans e breadcrumbs de usu√°rio.
- Hooks de lifecycle: `CaptureApplicationStartup/Shutdown` (monitoring.go) e `TraceApplicationStartup/Shutdown` (tracing.go) produzem spans e eventos em Sentry.
- `helpers.go` ganhou sanitiza√ß√£o de URLs/headers antes de logar, evitando exposi√ß√£o de segredos.
- `global_webhook.go`, `global_sqs.go` e `global_redis.go` foram refor√ßados com retries exponenciais, sanitiza√ß√£o de metadados (`SanitizeTransportMetadata`) e cabe√ßalho `X-Event-ID`.
- `media_processor.go` e `media_helpers.go` compartilham tratamento de m√≠dia (base64 ‚Üî S3) com gera√ß√£o de chave consistente por evento.
- O ciclo de shutdown passa a aguardar `FlushMonitoring`/`TraceApplicationShutdown`, incluindo timeout controlado e encerramento seguro do tracer provider (inclusive quando tracing estiver desabilitado ‚Äî fallback no-op agora configurado em `tracing.go`).
- `RecoverWithSentry` e `AddBreadcrumb` est√£o dispon√≠veis para todos os handlers, garantindo captura de panics e breadcrumbs contextualizados (`category`, `message`, `timestamp`).
- O dispatcher armazena o JSON bruto do evento em `Metadata["_event_json"]`, reidratado antes do envio para transportes, preservando integridade do payload para auditoria/observabilidade.

#### üóÉÔ∏è Buffer SQL & Migrations
- `buffer/database.go` introduz buffer relacional com auto-migrations (`buffer/migrations.go`) e pruning configur√°vel.
- Pruner roda em background (auto ou manual via admin) com suporte a parti√ß√µes (Postgres), √≠ndices extras e gest√£o de DLQ (`ReplayDLQEvent`, `DeleteDLQEvent`).
- Novas constantes (`DefaultTransportConfig`) centralizam defaults de timeout, batch, workers e retries para todos os transportes globais.
- O buffer suporta drivers PostgreSQL, MySQL (5.7+/8.0) e SQLite, aplicando `SELECT FOR UPDATE SKIP LOCKED` quando dispon√≠vel e fallback seguro para cen√°rios legados; colunas ausentes s√£o criadas on-the-fly (`ensureBufferSchemaCompatibility`).
- M√©tricas internas (`persistentBufferMetrics`) acompanham enfileiramentos, confirma√ß√µes, DLQ e opera√ß√µes de prune, preparadas para exposi√ß√£o futura.
- A estrutura global de transportes agora √© totalmente plug√°vel:
  - `transports/interface.go` aceita clonagem profunda segura, metadados limpos e batch sending.
  - `global_dispatcher.go` registra transports globais (Webhook, SQS, Redis Streams, WebSocket, RabbitMQ) e individuais com `SanitizeTransportMetadata`, restaura√ß√£o de payload (`restoreEventFromMetadata`) e workers dedicados.
  - `global_webhook.go`, `global_sqs.go`, `global_redis.go`, `global_rabbitmq.go` e `global_websocket.go` compartilham o mesmo conjunto de defaults (timeout, retry delay, circuit breaker, batch) via `DefaultTransportConfig`, garantindo comportamento homog√™neo.
  - `individual_transports.go` encapsula Webhook/RabbitMQ por usu√°rio, enquanto `global_transports.go` mant√©m o registro centralizado de cada canal.
  - Circuit breaker, retry exponencial e controle de concorr√™ncia foram equiparados para todos os destinos, facilitando futuras integra√ß√µes (ex.: Kafka, gRPC) com o mesmo contrato.
  - Os novos adaptadores globais permitem fan-out simult√¢neo: Webhook com idempot√™ncia (`X-Event-ID`), RabbitMQ com `MessageId`, SQS com deduplica√ß√£o FIFO opcional, Redis Streams com `XAdd` resiliente e WebSocket com compress√£o e reconex√£o autom√°tica.

#### üìä Ferramentas de teste e monitoramento
- `cmd/loadtest` oferece modo memory/sqlite/postgres/mysql com controle de produtores/consumidores, payload size e TPS alvo, registrando `enq_rate`, `ack_rate`, `failed` e dura√ß√£o total diretamente nos logs (√∫til para testes de capacidade).
- `BUFFER_MIGRATION_GUIDE.md` documenta toda a jornada de migra√ß√£o, inclusive rollback, diagn√≥stico de √≠ndices/locks e resolu√ß√£o de hotspots de DLQ.

### üõ†Ô∏è Configura√ß√£o e Vari√°veis de Ambiente
- `.env.sample` recebeu vari√°veis globais para buffer SQL (`GLOBAL_EVENT_BUFFER_*`), SQS, Redis, WebSocket e eco de API (`ECHO_API_MESSAGES_ENABLED`).
- Logs/Sentry: novos envs (`DINASTIAPI_LOG_LEVEL`, `LOG_TYPE`, `LOG_COLOR`) aplicados automaticamente ao iniciar.
- `go.mod` renomeado para o m√≥dulo `dinastiapi` e promoveu `golang.org/x/image` a depend√™ncia direta (renderiza√ß√£o de miniaturas e processamento de m√≠dia).
- Destaque para `LICENSE_KEY` com exemplos reais (BASIC x ENTERPRISE) e campo `SERVER_IP`, essencial para clientes que exp√µem rotas p√∫blicas em m√∫ltiplos ambientes.
- Novo `BUFFER_MIGRATION_GUIDE.md` explica passo a passo a migra√ß√£o entre SQLite, PostgreSQL e MySQL com estrat√©gias de reten√ß√£o, parti√ß√µes e testes de carga.
- Vari√°veis relevantes e exemplos pr√°ticos:
  ```env
  # Observabilidade
  DINASTIAPI_LOG_LEVEL=debug     # debug|info|warn|error
  LOG_TYPE=json                 # json (default) ou console
  LOG_COLOR=true                # for√ßa cores no console
  SENTRY_DSN=https://...@sentry.io/123
  SENTRY_ENVIRONMENT=production
  SENTRY_SAMPLE_RATE=1.0        # 0‚Äì1, controla volume de eventos

  # Buffer persistente (usar SQLite local ou banco j√° existente da API)
  GLOBAL_EVENT_BUFFER_USE_DATABASE=true
  GLOBAL_EVENT_BUFFER_VISIBILITY_TIMEOUT=45s
  GLOBAL_EVENT_BUFFER_RETRY_BASE=5s
  GLOBAL_EVENT_BUFFER_RETRY_MAX=2m
  GLOBAL_EVENT_BUFFER_MAX_ATTEMPTS=12
  GLOBAL_EVENT_BUFFER_ARCHIVE_RETENTION=168h   # 7 dias
  GLOBAL_EVENT_BUFFER_ARCHIVE_SUCCESS=true     # armazena sucesso p/ auditoria

  # SQS (opcional)
  GLOBAL_SQS_ENABLED=true
  GLOBAL_SQS_QUEUE_URL=https://sqs.us-east-1.amazonaws.com/123/dinastiapi-global
  GLOBAL_SQS_REGION=us-east-1
  GLOBAL_SQS_DELAY_SECONDS=0
  GLOBAL_SQS_MAX_RETRIES=3

  # Redis Streams (opcional)
  GLOBAL_REDIS_ENABLED=true
  GLOBAL_REDIS_ADDRESS=redis:6379
  GLOBAL_REDIS_STREAM=dinastiapi.events

  # WebSocket Broadcast (opcional)
  GLOBAL_WEBSOCKET_ENABLED=true
  GLOBAL_WEBSOCKET_ENDPOINTS=wss://ws.example.com/broadcast

  # Eco de API
  ECHO_API_MESSAGES_ENABLED=true
  ```
- Orienta√ß√µes de uso:
  - Em ambientes com container/orquestrador, defina `SERVER_IP` ou `PUBLIC_BASE_URL` para que o campo `baseURL` seja calculado corretamente mesmo com m√∫ltiplos listeners.
  - Para habilitar o buffer SQL com o mesmo banco da aplica√ß√£o, basta manter `GLOBAL_EVENT_BUFFER_USE_DATABASE=true` ‚Äî o wrapper compartilha a conex√£o principal (Postgres/MySQL) e aplica as migra√ß√µes automaticamente.
  - Caso prefira SQLite local, deixe `GLOBAL_EVENT_BUFFER_USE_DATABASE=false` e configure `GLOBAL_EVENT_BUFFER_PATH=./data/buffer/global.db`.
  - O eco de API depende tanto da flag global (`ECHO_API_MESSAGES_ENABLED`) quanto da prefer√™ncia do usu√°rio (`POST /session/echo/api`). Em cen√°rios multi-tenant, recomenda-se deixar o global desabilitado e permitir opt-in individual.
  - Para clientes Enterprise, exponha o `LICENSE_KEY` no container/host e reinicie a aplica√ß√£o para liberar bot√µes/flows sem necessidade de reconstruir bin√°rios.

### üìö Documenta√ß√£o e Guias
- Guia dos agentes (`AGENTS.md`) e playbook do Claude (`CLAUDE.md`) atualizados com a nova arquitetura de buffer, observabilidade e comandos de load test.
- README reorganizado com fluxos de buffer/unified transport e instru√ß√µes para eco de API.
- Documentos obsoletos (roadmap, TODO, delivery guarantees legado) removidos em favor do novo guia de migra√ß√£o.

### üì¶ Depend√™ncias e Protocolos
- `go.mau.fi/whatsmeow` atualizado para `54a1f619e047`, sincronizando protos (`WAWeb`, `WAE2E`, `WASyncAction`, `WAStatusAttributions`) e helpers de envio.
- Buffer SQLite recebeu pragmas adicionais (WAL, cache, mmap) para performance em mono inst√¢ncia.
- Atualiza√ß√µes relevantes do fork `whatsmeow`:
  - Suporte a mensagens interativas/flows com novos campos em `WAWebProtobufsWeb` e `WAWebProtobufsE2E`.
  - Melhorias de reconex√£o e estado do usu√°rio (`whatsmeow-private/user.go`) para evitar quedas ao ativar eco de API.
  - Ajustes em `send.go`/`sendfb.go` para preservar `ContextInfo` em mensagens com bot√µes e rich cards.
  - Corre√ß√£o definitiva dos *message reactions* em dispositivos que apresentavam inconsist√™ncias: o fork agora garante compatibilidade com clientes Android/iOS recentes, devolvendo rea√ß√µes no formato esperado e refletindo corretamente no eco de API.

### üêõ Corre√ß√µes
- Eventos individuais deixaram de ignorar o buffer (BUG #2 e BUG #3):
  - Retentativas agora seguem pol√≠tica global (at√© 12 tentativas com backoff 5s ‚Üí 2min).
  - Processos derrubados n√£o perdem mensagens (WAL + re-enqueue via DLQ).
  - Fim das goroutines √≥rf√£s ‚Äî workers usam pool gerenciado por dispatcher.
- `global_dispatcher` restaura o payload original antes de enviar ao transporte, evitando perda de campos ao consumir metadados.

### ‚ö†Ô∏è Breaking Changes
- **Idempot√™ncia obrigat√≥ria** para consumidores individuais:
  - Webhooks devem deduplicar via cabe√ßalho `X-Event-ID`.
  - RabbitMQ deve usar `MessageId` para evitar reprocessamento.
  - Exemplos de handlers idempotentes est√£o inclu√≠dos na documenta√ß√£o interna.

### üìà Estat√≠sticas da Vers√£o
- 4 commits principais nesta release:
  - `feat(core): overhaul buffer pipeline and observability`
  - `docs: refresh guides for the new event pipeline`
  - `docs(api): regenerate OpenAPI spec and dashboard bundle`
  - `chore(whatsmeow): sync private fork to 54a1f619e047`

## [v1.2.4] - 2025-09-08

### ‚ú® Destaques da vers√£o
- BaseURL em todos os eventos (Webhook + RabbitMQ) sem poluir o payload do usu√°rio. Cabe√ßalhos e campos dedicados garantem rastreabilidade/end-to-end.
- S3 Global com modo ‚ÄúOwner enforced‚Äù: novo `GLOBAL_S3_DISABLE_ACL` (default: true). Sem√¢ntica clara de entrega (`base64`, `url` ou `both`).
- Chamadas: rejei√ß√£o autom√°tica com mensagem/tipo globais configur√°veis e fallback robusto por usu√°rio.
- M√≠dia: detec√ß√£o MIME inteligente, link preview ‚Äúclean‚Äù (og:image, favicon e YouTube), thumbnails de v√≠deo (ffmpeg) e PDFs (p√°ginas + miniatura).
- LID (Link ID): novos endpoints para converter Phone/JID ‚Üî LID e listar mapeamentos. Store SQL entende `@lid` e `@s.whatsapp.net` no mesmo lookup.
- Grupos/Comunidades: cria√ß√£o com `context.Context` e flags (announcement/locked/ephemeral/approval); disappearing timer com timestamp.
- Whatsmeow (fork): pareamento h√≠brido (WhatsApp Business coexistente) e Presence sem PushName no contexto Messenger.

### üîß Mudan√ßas de configura√ß√£o
- Novas vari√°veis globais
  - `GLOBAL_CALL_REJECT_MESSAGE`: mensagem padr√£o de rejei√ß√£o de chamadas.
  - `GLOBAL_CALL_REJECT_TYPE`: `busy` | `decline` | `unavailable` (default: `busy`).
  - `GLOBAL_S3_DISABLE_ACL`: `true` para buckets AWS com ‚ÄúBucket owner enforced‚Äù; `false` para provedores legados (default: `true`).
- `WA_VERSION` atualizado para `2.3000.1026436087`.
- BaseURL passa a ser calculado e cacheado (carregando `.env` automaticamente quando presente). Vari√°veis √∫teis: `DINASTIAPI_ADDRESS` e `DINASTIAPI_PORT`.

### üîå API e Eventos
- BaseURL incorporado nos eventos
  - Cabe√ßalhos adicionais nos webhooks: `X-DinastiAPI-BaseURL` (al√©m de usu√°rio/token/jid/eventType).
  - Envelope dos eventos inclui `baseURL` e `source` (p.ex. `dinastiapi-global`).
- Novos endpoints LID
  - `GET/POST /user/lid/get` ‚Äî Converte Phone/JID ‚Üí LID.
  - `GET/POST /user/lid/from-lid` ‚Äî Converte LID ‚Üí Phone/JID.
  - `GET /user/lid/mappings` ‚Äî Lista todos os mapeamentos LID ‚Üî Phone do usu√°rio.
- Exemplo (curl) ‚Äî obter LID a partir de JID
  ```bash
  curl -H "token: <USER_TOKEN>" \
       "https://<BASE_URL>/user/lid/get?phone=5521971532700@s.whatsapp.net"
  ```
- Exemplo (Webhook payload ‚Äî campos relevantes)
  ```json
  {
    "userToken":"***",
    "userID":"***",
    "eventType":"message",
    "userName":"Alice",
    "userJID":"55219...@s.whatsapp.net",
    "baseURL":"https://api.seudominio.com",
    "timestamp": 1725750000,
    "source": "dinastiapi-global",
    "data": { "...": "payload do evento sem polui√ß√£o por metadados de S3" }
  }
  ```

### ‚òÅÔ∏è S3 (Global e por usu√°rio)
- Modo delivery global: `GLOBAL_S3_MEDIA_DELIVERY=base64|url|both`.
  - `url`: upload para S3 e remo√ß√£o do campo `base64` do payload.
  - `both`: upload para S3 mantendo o `base64` no payload.
- `GLOBAL_S3_DISABLE_ACL=true` (AWS moderno) evita aplicar ACL no upload; quando `false`, ACL p√∫blica √© aplicada (compatibilidade com provedores legados).
- Endpoints de S3 do usu√°rio expostos com `disable_acl` no retorno e nos testes de conex√£o.

### üìû Chamadas: rejei√ß√£o autom√°tica
- Fallback global quando usu√°rio n√£o definiu mensagem/tipo:
  - `GLOBAL_CALL_REJECT_MESSAGE` e `GLOBAL_CALL_REJECT_TYPE`.
  - Valida√ß√£o de tipo ‚Äî valores inv√°lidos caem para `busy` com aviso em log.

### üñºÔ∏è M√≠dia e Previews
- Detec√ß√£o MIME inteligente ‚Äî corrige `application/octet-stream` em √°udios/documentos.
- PTT (voice note): for√ßa `audio/ogg; codecs=opus` quando necess√°rio.
- Link preview ‚Äúclean‚Äù: coleta metadados (OpenGraph/Twitter), baixa thumbnail e envia como `MediaLinkThumbnail`. Suporte expandido para YouTube via oEmbed e scraping.
- PDF: p√°gina inicial renderizada como thumbnail (com largura/altura reais) + `pageCount` no documento.
- V√≠deo: thumbnail gerado em mem√≥ria com fallback autom√°tico para imagem padr√£o quando `ffmpeg` ausente.

### üë• Grupos/Comunidades
- `CreateGroup(context, req)` com suporte a `announcement`, `locked`, `ephemeral` e `membership_approval_mode`.
- `SetDisappearingTimer(..., settingTS)` grava timestamp de configura√ß√£o para melhor compatibilidade com o cliente.

### üîê Whatsmeow (fork privado)
- Pareamento h√≠brido (coexistente): fallback de verifica√ß√£o de assinatura com tipo de conta oposto para lidar com inconsist√™ncias de detec√ß√£o (Business/Hosted/regular).
- Presence: envia sem `PushName` quando em contexto Messenger E2EE.

### üóÉÔ∏è Migra√ß√µes de banco
- Migra√ß√£o 15 ‚Äî cache de avatar: adiciona `avatar_url` e `avatar_updated_at`.
- Migra√ß√£o 16 ‚Äî S3 sem ACL: adiciona `s3_disable_acl` (default TRUE).
- Compat√≠vel com PostgreSQL e MySQL (SQLite auxilia desenvolvimento). Aplicadas automaticamente no startup.

### üì¶ Depend√™ncias e Tooling
- Go toolchain 1.24.x, bibliotecas atualizadas (protobuf, goquery, unipdf, x/*, etc.).
- CI: matriz Go 1.24/1.25; pre-commit atualizado.
- Protobufs WhatsApp atualizados (E2E/Wa6/SyncAction/HistorySync/StatusAttributions/CompanionReg/Armadillo) e migra√ß√£o de `WAWebProtobufsBotMetadata` ‚Üí `WABotMetadata`.


## [v1.2.3] - 2025-08-15

### üöÄ Novos Recursos

#### üìö Swagger/OpenAPI Nativo

- ‚úÖ **Documenta√ß√£o Autom√°tica**: Gera√ß√£o autom√°tica de specs com UI embutida
  - Endpoint `/api/` para interface interativa
  - Artefatos em `static/api/swagger.json|yaml|docs.go`
  - Anota√ß√µes nos handlers principais
  - Metadados centralizados em `main.go`
- ‚úÖ **Domains Documentados**: Admin/Global, Session, Chat, Group, Community, Newsletter, Privacy, Business, Device, Webhook
- ‚úÖ **Sem Breaking Changes**: Compatibilidade total com APIs existentes

#### üóÑÔ∏è Suporte Completo a MySQL

- ‚úÖ **Novo Provedor MySQL**: Suporte nativo com migra√ß√µes dedicadas
  - DSN: `mysql://user:pass@host:3306/db?charset=utf8mb4&parseTime=True&loc=Local`
  - Convers√£o autom√°tica de placeholders ($1 ‚Üí ?) via `DatabaseWrapper`
  - `initialSchemaMySQLSQL` e migra√ß√µes condicionais por driver
- ‚úÖ **Compatibilidade Mantida**: SQLite e PostgreSQL continuam funcionando
- ‚úÖ **Docker Compose**: Servi√ßo MySQL opcional com tuning e healthcheck

#### üì± Novos Endpoints de Chat

- ‚úÖ **Envio de PTV**: `POST /chat/send/ptv`
  - Pre-Recorded Transfer Video por link ou base64
  - Suporte a headers de m√≠dia
  ```json
  {
    "Phone": "5511999999999",
    "Video": "https://example.com/video.mp4"
  }
  ```
- ‚úÖ **Retry de Mensagens**: `POST /chat/retry/message`
  - Reprocessamento/recupera√ß√£o de mensagens recebidas
  - Estrat√©gia: BuildUnavailableMessageRequest + envio ao pr√≥prio dispositivo
  ```json
  {
    "MessageID": "ABCD1234...",
    "ChatJID": "5511999999999@s.whatsapp.net",
    "SenderJID": "5511888888888@s.whatsapp.net",
    "RetryType": "incoming",
    "ForceRetry": true
  }
  ```

#### üåê Proxy Configur√°vel por Usu√°rio

- ‚úÖ **Endpoint de Proxy**: `POST /session/proxy`
  - Suporte a `http://`, `https://` e `socks5://`
  - Configura√ß√£o individual por usu√°rio
  - Indica√ß√£o de necessidade de reconex√£o
  ```json
  {
    "enable": true,
    "proxy_url": "socks5://user:pass@proxy.example.com:1080"
  }
  ```

#### ‚öôÔ∏è Configura√ß√µes Avan√ßadas de Dispositivo WhatsApp (Alpha)

- ‚úÖ **Configura√ß√µes Globais e por Inst√¢ncia**: Controle total sobre par√¢metros do dispositivo
  - Aplicadas ANTES da conex√£o
  - Configura√ß√µes por usu√°rio sobrep√µem globais
  - Valores inv√°lidos geram warn e usam defaults
- ‚úÖ **Enums Suportados**:
  - **waPlatform**: ANDROID, IOS, WINDOWS_PHONE, WEB, MACOS, etc.
  - **waReleaseChannel**: RELEASE, BETA, ALPHA, DEBUG
  - **waWebSubPlatform**: WEB_BROWSER, APP_STORE, WIN_STORE, DARWIN
  - **waConnectType**: WIFI_UNKNOWN, CELLULAR_LTE, CELLULAR_UMTS, etc.
  - **waPlatformType**: CHROME, FIREFOX, SAFARI, ANDROID_PHONE, IOS_PHONE, etc.
- ‚úÖ **Vari√°veis de Ambiente**:
  ```bash
  WA_VERSION=2.2413.51
  WA_PLATFORM=WEB
  WA_RELEASE_CHANNEL=RELEASE
  WA_OS_NAME=Mac OS
  WA_DEVICE_NAME=MacBook Pro
  WA_LOCALE_LANGUAGE=pt
  WA_LOCALE_COUNTRY=BR
  ```

### üõ†Ô∏è Melhorias T√©cnicas

#### üîÑ Atualiza√ß√µes do whatsmeow-private

- ‚úÖ **Compatibilidade Recente**: Recursos mais recentes do WhatsApp
- ‚úÖ **Otimiza√ß√µes de Performance**: Melhorias no core da biblioteca
- ‚úÖ **Estabilidade**: Corre√ß√µes e melhorias de conectividade

#### ‚ö° Otimiza√ß√µes de Performance

- ‚úÖ **RabbitMQ**: Configura√ß√µes globais e individuais
- ‚úÖ **Skips Configur√°veis**: Otimiza√ß√µes de processamento
- ‚úÖ **Processamento Ass√≠ncrono**: Melhor handling de mensagens

#### üèóÔ∏è Refatora√ß√£o de Tipos

- ‚úÖ **Organiza√ß√£o por Dom√≠nio**: Tipos reorganizados em `types/*`
- ‚úÖ **Remo√ß√£o de `types/index.go`**: Estrutura mais limpa
- ‚úÖ **Imports Ajustados**: Melhor organiza√ß√£o do c√≥digo
- ‚úÖ **Payloads Padronizados**: Compatibilidade com Swagger

### üì¶ Exemplos de Uso

#### Enviar PTV

```bash
curl -X POST "http://localhost:8080/chat/send/ptv" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "Phone": "5511999999999",
    "Video": "https://example.com/video.mp4"
  }'
```

#### Configurar Proxy

```bash
curl -X POST "http://localhost:8080/session/proxy" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "enable": true,
    "proxy_url": "socks5://user:pass@proxy.example.com:1080"
  }'
```

#### Retry de Mensagem

```bash
curl -X POST "http://localhost:8080/chat/retry/message" \
  -H "token: <USER_TOKEN>" -H "Content-Type: application/json" \
  -d '{
    "MessageID": "ABCD1234...",
    "ChatJID": "5511999999999@s.whatsapp.net",
    "SenderJID": "5511888888888@s.whatsapp.net",
    "RetryType": "incoming",
    "ForceRetry": true
  }'
```

### üìà Estat√≠sticas da Vers√£o

| Categoria            | Quantidade             |
| -------------------- | ---------------------- |
| **Novos Endpoints**  | 3 rotas                |
| **Banco de Dados**   | MySQL + migra√ß√µes      |
| **Documenta√ß√£o**     | Swagger nativo         |
| **Configura√ß√µes WA** | 20+ par√¢metros         |
| **Otimiza√ß√µes**      | Performance + RabbitMQ |

### üîÑ Compatibilidade

- ‚úÖ **Sem Breaking Changes**: Total compatibilidade com vers√µes anteriores
- ‚úÖ **APIs Existentes**: Todas as funcionalidades anteriores mantidas
- ‚úÖ **Bancos de Dados**: SQLite, PostgreSQL e MySQL suportados
- ‚úÖ **Configura√ß√µes**: Migra√ß√£o autom√°tica e transparente

### üîß Migra√ß√£o/Upgrade

- **Banco de Dados**: Drivers mantidos; MySQL plug√°vel; migra√ß√µes condicionadas por driver
- **Documenta√ß√£o**: Acessar `/api/` para interface Swagger
- **Dispositivo**: Vari√°veis WA\_\* opcionais; configura√ß√µes por inst√¢ncia (alpha) requerem reconex√£o
- **Proxy**: Configura√ß√£o individual por usu√°rio sem impacto em outros

### üîí Seguran√ßa e Observabilidade

- ‚úÖ **Logs Estruturados**: Melhor rastreabilidade
- ‚úÖ **M√©tricas Globais**: Estat√≠sticas expostas por endpoints Admin/Global
- ‚úÖ **Valida√ß√µes**: Mensagens claras para proxy, retry e configura√ß√µes WA inv√°lidas
- ‚úÖ **Fallbacks**: Configura√ß√µes inv√°lidas usam defaults seguros

---

## [v1.2.2] - 2025-07-27

### üöÄ Novos Recursos

#### üéØ Mensagens Interativas

- ‚úÖ **Mensagens de Lista**: Suporte para single select
- ‚úÖ **Novos Endpoints**: `/chat/send/list`

#### üí¨ Gerenciamento Avan√ßado de Chat

- ‚úÖ **Pin/Unpin**: Fixar e desfixar conversas importantes
- ‚úÖ **Arquivamento**: Arquivar e desarquivar conversas
- ‚úÖ **Silenciamento**: Silenciar chats por per√≠odos (8h, 1 semana, sempre)
- ‚úÖ **Favoritos**: Marcar/desmarcar mensagens com estrela
- ‚úÖ **Sistema de Labels**: Gerenciamento completo de etiquetas
  - Editar labels existentes
  - Aplicar em chats e mensagens
  - Organiza√ß√£o inteligente

#### üîí Privacidade e Seguran√ßa

- ‚úÖ **Configura√ß√µes de Privacidade**: Controle total sobre visibilidade
- ‚úÖ **Timer de Mensagens**: Configurar mensagens tempor√°rias
- ‚úÖ **Lista de Bloqueados**: Gerenciar contatos bloqueados
- ‚úÖ **Privacidade de Status**: Controlar quem v√™ seus status
- ‚úÖ **Configura√ß√µes Avan√ßadas**: Todas as op√ß√µes de privacidade do WhatsApp

#### üë• Comunidades WhatsApp

- ‚úÖ **Cria√ß√£o de Comunidades**: Criar e gerenciar comunidades
- ‚úÖ **Vincula√ß√£o de Grupos**: Conectar grupos √†s comunidades
- ‚úÖ **An√∫ncios**: Enviar an√∫ncios para toda a comunidade
- ‚úÖ **Administra√ß√£o**: Sistema completo de modera√ß√£o
- ‚úÖ **Solicita√ß√µes**: Gerenciar pedidos de entrada

#### üíº Recursos Business

- ‚úÖ **Links Business**: Resolver links de mensagens business
- ‚úÖ **QR Code de Contato**: Gerar QR codes para contatos
- ‚úÖ **Gerenciamento de Bots**: Listar e configurar bots
- ‚úÖ **Perfis de Bots**: Informa√ß√µes detalhadas de bots
- ‚úÖ **Mensagens de Pedido**: Enviar mensagens de pedido (order message)

#### üì± Gerenciamento de Dispositivos

- ‚úÖ **Listagem de Dispositivos**: Ver todos os dispositivos conectados
- ‚úÖ **Dispositivos Vinculados**: Identificar dispositivos do usu√°rio
- ‚úÖ **Identifica√ß√£o de Plataforma**: Detectar sistema operacional
- ‚úÖ **Consultas Contextuais**: Buscas avan√ßadas com contexto

### üõ†Ô∏è Melhorias T√©cnicas

#### üîß Painel Administrativo

- ‚úÖ **Avatares de Usu√°rios**: Exibi√ß√£o de fotos de perfil
- ‚úÖ **M√©todo Interno**: `getAvatarInternal()` para busca eficiente
- ‚úÖ **Informa√ß√µes Completas**: Listagem aprimorada de usu√°rios
- ‚úÖ **Status de Conex√£o**: Indicadores visuais de conectividade

#### üìä Constantes e Valida√ß√µes

- ‚úÖ **Tipos de Eventos**: Novos eventos suportados
- ‚úÖ **Mapa de Eventos**: Valida√ß√£o r√°pida e eficiente
- ‚úÖ **Fun√ß√£o de Valida√ß√£o**: `isValidEventType()` para verifica√ß√µes

#### üîó Helpers e Utilit√°rios

- ‚úÖ **Processamento de M√≠dia**: Novos helpers para m√≠dia
- ‚úÖ **Mensagens Interativas**: Fun√ß√µes auxiliares especializadas
- ‚úÖ **Sistema de Callbacks**: Melhorias nos webhooks

#### üõ£Ô∏è Rotas e Endpoints

- ‚úÖ **35+ Novas Rotas**: Endpoints RESTful adicionados
- ‚úÖ **Organiza√ß√£o por Dom√≠nio**: Estrutura clara e l√≥gica
  - `/chat/*` - Opera√ß√µes de chat
  - `/privacy/*` - Configura√ß√µes de privacidade
  - `/community/*` - Gerenciamento de comunidades
  - `/business/*` - Recursos business
  - `/device/*` - Gerenciamento de dispositivos

#### üì§ Handlers de Envio

- ‚úÖ **SendListMessage()**: Suporte total para listas
- ‚úÖ **Valida√ß√µes Robustas**: Tratamento de erros aprimorado

### üì¶ Novos Servi√ßos

#### üè≠ Factory de Mensagens

- ‚úÖ **create_list_message_service.go**
  - Factory para mensagens de lista
  - M√∫ltiplas se√ß√µes suportadas
  - Valida√ß√µes de tamanho e conte√∫do

### üìà Estat√≠sticas da Vers√£o

| Categoria             | Quantidade   |
| --------------------- | ------------ |
| **Novos Handlers**    | 9 arquivos   |
| **Novos Endpoints**   | 35+ rotas    |
| **Novos Servi√ßos**    | 3 servi√ßos   |
| **Novas Fun√ß√µes**     | 100+ fun√ß√µes |
| **Recursos WhatsApp** | Completo     |

### üîÑ Compatibilidade

- ‚úÖ **Sem Breaking Changes**: Total compatibilidade com vers√µes anteriores
- ‚úÖ **APIs Existentes**: Todas as funcionalidades anteriores mantidas
- ‚úÖ **Configura√ß√µes**: Compatibilidade total com configura√ß√µes existentes

### üìö Documenta√ß√£o

- ‚úÖ **CHANGELOG.md**: Atualizado com todas as mudan√ßas
- ‚úÖ **Dockerfile**: Melhorias na imagem Docker
- ‚úÖ **docker-compose**: Configura√ß√µes atualizadas
- ‚úÖ **API Spec**: Documenta√ß√£o da API atualizada
- ‚úÖ **Postman**: Cole√ß√£o atualizada
- ‚úÖ **Dashboard**: Interface HTML melhorada

## üìä Estat√≠sticas

- **Total de commits**: 64
- **Per√≠odo**: 2025-06-11 at√© 2025-07-13

### üë• Principais Contribuidores

- **Guilherme Jansen**: 52 commit(s)
- **GitHub Action**: 10 commit(s)
- **GitHub Actions Bot**: 2 commit(s)

### üîó Links √öteis

- [üöÄ GitHub Repository](https://github.com/DinastIA-UK/use-dinastiapi)
- [üê≥ Docker Hub](https://hub.docker.com/r/dinastiapi/dinastiapi-private)
- [üìñ Documenta√ß√£o](https://github.com/DinastIA-UK/use-dinastiapi/blob/main/README.md)
- [üÜò Suporte](mailto:contato@dinastiapi.com)
